<!DOCTYPE html>
<html>

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=2.0">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
      integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
      crossorigin="anonymous"></script>
    <style>
      body {
        background-color: #222;
        font-family: 'Roboto', sans-serif;
        margin: 0;
      }

      h1 {
        margin-top: 0;
      }

      h1,
      label {
        color: #fff
      }

      input[orient=vertical] {
        appearance: slider-vertical;
      }

      .hidden {
        display: none;
      }

      .range-group {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
        border: 1px #333 solid;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 2rem;
        width: max-content;
        margin: 1rem;
      }

      .range-container {
        display: flex;
      }

      .range-controls {
        display: grid;
        grid-template-columns: min-content 3rem;
        grid-template-rows: min-content 1fr min-content;
        align-items: center;
      }

      .range {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-right: 1rem;
      }

      .range:last-child {
        padding-right: 0;
      }

      .range-input.slider {
        grid-column-start: 1;
        grid-row-start: 1;
        grid-row-end: 4;
        width: 2rem;
        height: 300px;
      }

      .range-input.full-button,
      .range-input.half-button,
      .range-input.none-button {
        grid-column-start: 2;

        background-color: #333;
        color: #FFF;
        border: none;
        border-radius: 2rem;
        padding: 0.5rem;
      }

      .range-input.full-button:active,
      .range-input.half-button:active,
      .range-input.none-button:active {
        background-color: #555;
      }

      .range-label-decoration {
        background-color: #333;
        width: 100%;
        text-align: center;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        margin-top: 1rem;
        border-radius: 2rem;
      }

      .banner-container {
        display: none
      }

      .banner-content-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        color: #FFF;
      }

      .banner-content-wrapper .banner-content {
        padding: 1rem;
      }

      /* .banner-content-wrapper.disconnected {
        background-color: #500;
      } */

    </style>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  </head>

  <body>
    <div class="banner-container">
      <div class="banner-content-wrapper">
        <span class="banner-content">Disconnected</span>
      </div>
    </div>

    <div class="range-template hidden">

      <div class="range">
        <div class="range-controls">
          <input class="range-input slider" type="range" min="0" max="100" step="1" orient="vertical" value="0" />
          <button class="range-input full-button">100</button>
          <button class="range-input half-button">50</button>
          <button class="range-input none-button">0</button>
        </div>
        <div class="range-label-decoration">
          <label class="range-label"></label>
        </div>
      </div>

      <div class="range-group">
        <h1 class="title"></h1>
        <div class="range-container"></div>
      </div>

    </div>

    <div class="range-group-container">
      <!-- Place ranges here -->
    </div>

    <script type="text/javascript" charset="utf-8">
      class Banner {
        constructor() {
          this.container = document.body.querySelector(".banner-container");
          this.wrapper = this.container.querySelector(".banner-content-wrapper");
          this.content = this.wrapper.querySelector(".banner-content");
        }

        set(type, message, timer = 0) {
          this._setContentType(type);
          this._setContent(message);
          this._setVisible();

          if (timer > 0)
          {
            setTimeout(() => {
              this.remove();
            }, timer);
          }
        }

        remove() {
          this._setHidden();
          this._clearContent();
        }

        _setContentType(type) {
          const s = this.wrapper.style;
          switch (type)
          {
            case "success":
              s.backgroundColor = "green";
              break;
            case "error":
              s.backgroundColor = "red";
              break;
            default:
              s.backgroundColor = "transparent";
              console.error("Unrecognized banner type:", type);
          }
        }

        _setVisible() {
          this.container.style.display = "block";
        }

        _setHidden() {
          this.container.style.display = "none";
        }

        _clearContent() {
          this.content.innerText = "";
        }

        _setContent(message) {
          this.content.innerText = message;
        }
      }

      const socket = io();
      const banner = new Banner();

      socket.on('connect', function () {
        banner.set("success", "Connected", 1000);
      });

      socket.on("disconnect", () => {
        banner.set("error", "Disconnected");
      });

      function sendMessage(path, channel, rawValue) {
        const value = rawValue / 100;
        socket.emit("json", { path, channel, value });
      }

      const getInputId = (title, i) => {
        return `range-${title}-${i}-input`;
      };

      const rangeTemplate = document.querySelector(".range-template .range");
      const rangeGroupTemplate = document.querySelector(".range-group");
      const rangeGroupContainer = document.querySelector(".range-group-container");

      function rangeGroupFactory(title, ranges) {
        const rangeGroup = rangeGroupTemplate.cloneNode(true);
        rangeGroup.querySelector(".title").innerText = title;
        const rangeContainer = rangeGroup.querySelector(".range-container");
        ranges.forEach((range) => {
          rangeContainer.appendChild(range.node);
        });
        return {
          node: rangeGroup,
          ranges
        };
      }

      function rangeFactory(path, count) {
        const ranges = Array(8).fill(null).map((_, channel) => {
          const node = rangeTemplate.cloneNode(true);
          const inputId = getInputId(path, channel);
          const rangeInputSliderDiv = node.querySelector(".range-input.slider");
          const rangeLabelDiv = node.querySelector(".range-label");
          rangeInputSliderDiv.id = inputId;
          rangeLabelDiv.htmlFor = inputId;
          rangeLabelDiv.innerText = channel;

          const sliderListener = rangeInputSliderDiv.addEventListener("input", (e) => {
            sendMessage(path, channel, e.target.value);
          });

          const buttons = [
            {
              value: 100,
              buttonNode: node.querySelector(".range-input.full-button")
            },
            {
              value: 50,
              buttonNode: node.querySelector(".range-input.half-button")
            },
            {
              value: 0,
              buttonNode: node.querySelector(".range-input.none-button")
            }
          ].map(({ value, buttonNode }) => {
            return buttonNode.addEventListener("click", () => {
              rangeInputSliderDiv.value = value;
              sendMessage(path, channel, value);
            });

          });


          return {
            node: node,
            listeners: {
              slider: sliderListener,
              buttons
            }
          };
        });

        return ranges;
      }

      const rangesCC = rangeFactory("cc", 8);
      const rangeGroupCC = rangeGroupFactory("Control Change", rangesCC);
      rangeGroupContainer.appendChild(rangeGroupCC.node);

      const rangesSynth = rangeFactory("/synth", 8);
      const rangeGroupSynth = rangeGroupFactory("Synth", rangesSynth);
      rangeGroupContainer.appendChild(rangeGroupSynth.node);

      const rangesReverb = rangeFactory("/reverb", 8);
      const rangeGroupReverb = rangeGroupFactory("Reverb", rangesReverb);
      rangeGroupContainer.appendChild(rangeGroupReverb.node);

    </script>
  </body>

</html>
