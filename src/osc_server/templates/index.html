<!DOCTYPE html>
<html>

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
      integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
      crossorigin="anonymous"></script>
    <style>
      body {
        background-color: #222;
        font-family: 'Roboto', sans-serif;
        margin: 0;
        user-select: none;
      }

      h1 {
        margin-top: 0;
      }

      h1,
      label {
        color: #fff
      }

      input[orient=vertical] {
        appearance: slider-vertical;
      }

      .hidden {
        display: none;
      }

      .range-group {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
        border: 1px #333 solid;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 2rem;
        width: max-content;
        margin: 1rem;
      }

      .range-container {
        display: flex;
      }

      .range-controls {
        display: grid;
        grid-template-columns: min-content 3.5rem;
        grid-template-rows: min-content 1fr 1fr 1fr min-content;
        align-items: center;
      }

      .range {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-right: 1.5rem;
      }

      .range:last-child {
        padding-right: 0;
      }

      .range-input.slider {
        grid-column-start: 1;
        grid-row-start: 1;
        grid-row-end: 6;
        width: 0.3rem;
        height: 300px;
      }

      .range-input.range-input-button {
        grid-column-start: 2;

        border: none;
        border-top-right-radius: 2rem;
        border-bottom-right-radius: 2rem;
        padding: 0.5rem 0.5rem 0.5rem 0.9rem;

        background-color: #111;
        color: #FFF;
        text-align: left;
      }

      .range-input.range-input-button:active {
        background-color: #555;
      }

      .range-label-decoration {
        width: 100%;
        text-align: center;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        margin-top: 0.5rem;
        border-radius: 0.5rem;
      }

      .range-label-decoration.range-key {
        background-color: #333;
      }

      .range-label-decoration.range-class {
        background-color: #111;
      }

      .banner-container {
        display: none
      }

      .banner-content-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        color: #FFF;
      }

      .banner-content-wrapper .banner-content {
        padding: 1rem;
      }

    </style>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  </head>

  <body>
    <div class="banner-container">
      <div class="banner-content-wrapper">
        <span class="banner-content">Disconnected</span>
      </div>
    </div>

    <div class="range-template hidden">

      <div class="range">
        <div class="range-controls">
          <button class="range-input range-input-button button-100">100</button>
          <button class="range-input range-input-button button-75">75</button>
          <button class="range-input range-input-button button-50">50</button>
          <button class="range-input range-input-button button-25">25</button>
          <button class="range-input range-input-button button-0">0</button>
          <input class="range-input slider" type="range" min="0" max="100" step="1" orient="vertical" value="0" />
        </div>
        <div class="range-label-decoration range-key">
          <label class="range-label range-key"></label>
        </div>
        <div class="range-label-decoration range-class hidden">
          <label class="range-label range-class"></label>
        </div>
      </div>

      <div class="range-group">
        <h1 class="title"></h1>
        <div class="range-container"></div>
      </div>

    </div>

    <div class="range-group-container">
      <!-- Place ranges here -->
    </div>

    <script type="text/javascript" charset="utf-8">
      class Banner {
        constructor() {
          this.container = document.body.querySelector(".banner-container");
          this.wrapper = this.container.querySelector(".banner-content-wrapper");
          this.content = this.wrapper.querySelector(".banner-content");
        }

        set(type, message, timer = 0) {
          this._setContentType(type);
          this._setContent(message);
          this._setVisible();

          if (timer > 0)
          {
            setTimeout(() => {
              this.remove();
            }, timer);
          }
        }

        remove() {
          this._setHidden();
          this._clearContent();
        }

        _setContentType(type) {
          const s = this.wrapper.style;
          switch (type)
          {
            case "success":
              s.backgroundColor = "green";
              break;
            case "error":
              s.backgroundColor = "red";
              break;
            default:
              s.backgroundColor = "transparent";
              console.error("Unrecognized banner type:", type);
          }
        }

        _setVisible() {
          this.container.style.display = "block";
        }

        _setHidden() {
          this.container.style.display = "none";
        }

        _clearContent() {
          this.content.innerText = "";
        }

        _setContent(message) {
          this.content.innerText = message;
        }
      }

      class Value {
        static normalize(value) {
          return value / 100;
        }

        static denormalize(value) {
          return value * 100;
        }
      }

      function sendMessage(key, channel, rawValue) {
        const value = Value.normalize(rawValue);
        socket.emit("json", { key, channel, value });
      }

      const getInputId = (title, i) => {
        return `range-${title}-${i}-input`;
      };

      const rangeTemplate = document.querySelector(".range-template > .range");
      const rangeGroupTemplate = document.querySelector(".range-template > .range-group");
      const rangeGroupContainer = document.querySelector(".range-group-container");

      function rangeGroupFactory(title, ranges) {
        const rangeGroup = rangeGroupTemplate.cloneNode(true);
        const titleDiv = rangeGroup.querySelector(".title");
        titleDiv.innerText = title;
        const rangeContainer = rangeGroup.querySelector(".range-container");
        ranges.forEach((range) => {
          rangeContainer.appendChild(range.node);
        });
        return {
          node: rangeGroup,
          ranges
        };
      }

      function rangeFactory(symbol, specs) {
        const ranges = specs.map(({ name, default: defaultValue, group }, channel) => {
          const node = rangeTemplate.cloneNode(true);
          const inputId = getInputId(symbol, channel);
          const rangeInputSliderDiv = node.querySelector(".range-input.slider");
          const rangeLabelKeyDiv = node.querySelector(".range-label.range-key");
          const rangeLabelGroupDiv = node.querySelector(".range-label.range-class");
          const rangeLabelDecoratorGroupDiv = node.querySelector(".range-label-decoration.range-class");

          rangeInputSliderDiv.defaultValue = Value.denormalize(defaultValue);
          rangeInputSliderDiv.id = inputId;
          rangeLabelKeyDiv.htmlFor = inputId;
          rangeLabelKeyDiv.innerText = name;
          if (group)
          {
            rangeLabelGroupDiv.innerText = group;
            rangeLabelDecoratorGroupDiv.classList.remove("hidden");
          }

          const sliderListener = rangeInputSliderDiv.addEventListener("input", (e) => {
            sendMessage(symbol, channel, e.target.value);
          });

          const buttons = Array(5).fill(0).map((_, i) => i * 25).map((value) => ({
            value,
            buttonNode: node.querySelector(`.range-input.button-${value}`),
          }));

          buttons.map(({ value, buttonNode }) => {
            return buttonNode.addEventListener("click", () => {
              rangeInputSliderDiv.value = value;
              sendMessage(symbol, channel, value);
            });
          });

          return {
            node: node,
            listeners: {
              slider: sliderListener,
              buttons
            }
          };
        });

        return ranges;
      }


      const SCD_SPECS = JSON.parse('{{ controls | safe }}');

      console.log({ SCD_SPECS });

      function createRangeGroups() {
        return SCD_SPECS.config.raw.controls.map(({ symbol, title, specs }) => {
          const rangesSynth = rangeFactory(symbol, specs);
          const rangeGroupSynth = rangeGroupFactory(title, rangesSynth);
          return rangeGroupSynth;
        });
      }

      const socket = io();
      const banner = new Banner();

      socket.on('connect', function () {
        banner.set("success", "Connected", 1000);

        const rangeGroups = createRangeGroups();
        rangeGroupContainer.innerHTML = "";
        rangeGroups.forEach(({ node }) => {
          rangeGroupContainer.appendChild(node);
        });
      });

      socket.on("disconnect", () => {
        banner.set("error", "Disconnected");
      });

    </script>
  </body>

</html>
